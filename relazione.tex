\documentclass[a4paper]{article}
%\documentclass[a4paper,10pt]{article}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
% \usepackage{xfrac}
% \usepackage[all]{xy}
\usepackage{mathtools}
\usepackage{graphicx}
% \usepackage{fullpage}
\usepackage{hyperref}
\usepackage[T1]{fontenc}
\usepackage[utf8x]{inputenc}
\usepackage[italian]{babel}
%\usepackage{lmodern}

% \usepackage{pdftricks}
% \begin{psinputs}
%    \usepackage{pstricks}
%    \usepackage{multido}
% \end{psinputs}

\usepackage{ulem}

\usepackage{tikz}
\usetikzlibrary{arrows}

% \setlength{\parindent}{0in}

% \newcounter{counter1}

% \theoremstyle{plain}
% \newtheorem{myteo}[counter1]{Teorema}
% \newtheorem{mylem}[counter1]{Lemma}
% \newtheorem{mypro}[counter1]{Proposizione}
% \newtheorem{mycor}[counter1]{Corollario}
% \newtheorem*{myteo*}{Teorema}
% \newtheorem*{mylem*}{Lemma}
% \newtheorem*{mypro*}{Proposizione}
% \newtheorem*{mycor*}{Corollario}

% \theoremstyle{definition}
% \newtheorem{mydef}[counter1]{Definizione}
% \newtheorem{myes}[counter1]{Esempio}
% \newtheorem{myex}[counter1]{Esercizio}
% \newtheorem*{mydef*}{Definizione}
% \newtheorem*{myes*}{Esempio}
% \newtheorem*{myex*}{Esercizio}

% \theoremstyle{remark}
% \newtheorem{mynot}[counter1]{Nota}
% \newtheorem{myoss}[counter1]{Osservazione}
% \newtheorem*{mynot*}{Nota}
% \newtheorem*{myoss*}{Osservazione}

\theoremstyle{plain}
\newtheorem{myteo}{Teorema}[section]
\newtheorem{mylem}[myteo]{Lemma}
\newtheorem{mypro}[myteo]{Proposizione}
\newtheorem{mycor}[myteo]{Corollario}
\newtheorem*{myteo*}{Teorema}
\newtheorem*{mylem*}{Lemma}
\newtheorem*{mypro*}{Proposizione}
\newtheorem*{mycor*}{Corollario}

\theoremstyle{definition}
\newtheorem{mydef}[myteo]{Definizione}
\newtheorem{myes}[myteo]{Esempio}
\newtheorem{myex}[myteo]{Esercizio}
\newtheorem*{mydef*}{Definizione}
\newtheorem*{myes*}{Esempio}
\newtheorem*{myex*}{Esercizio}

\theoremstyle{remark}
\newtheorem{mynot}[myteo]{Nota}
\newtheorem{myoss}[myteo]{Osservazione}
\newtheorem*{mynot*}{Nota}
\newtheorem*{myoss*}{Osservazione}


\newcommand{\obar}[1]{\overline{#1}}
\newcommand{\ubar}[1]{\underline{#1}}

\newcommand{\set}[1]{\left\{#1\right\}}
\newcommand{\pa}[1]{\left(#1\right)}
\newcommand{\ang}[1]{\left<#1\right>}
\newcommand{\bra}[1]{\left[#1\right]}
\newcommand{\abs}[1]{\left|#1\right|}
\newcommand{\norm}[1]{\left\|#1\right\|}

\newcommand{\pfrac}[2]{\pa{\frac{#1}{#2}}}
\newcommand{\bfrac}[2]{\bra{\frac{#1}{#2}}}
\newcommand{\psfrac}[2]{\pa{\sfrac{#1}{#2}}}
\newcommand{\bsfrac}[2]{\bra{\sfrac{#1}{#2}}}

\newcommand{\der}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\pder}[2]{\pfrac{\partial #1}{\partial #2}}
\newcommand{\sder}[2]{\sfrac{\partial #1}{\partial #2}}
\newcommand{\psder}[2]{\psfrac{\partial #1}{\partial #2}}

\newcommand{\intl}{\int \limits}

\DeclareMathOperator{\de}{d}
\DeclareMathOperator{\id}{Id}
\DeclareMathOperator{\len}{len}

\DeclareMathOperator{\gl}{GL}
\DeclareMathOperator{\aff}{Aff}
\DeclareMathOperator{\isom}{Isom}

\title{Problemi di instradamento su reti}
\date{\today}
\author{Enrico Polesel}

\begin{document}
\maketitle

\section{Introduzione ed esempi}

Nello studio dei trasporti e delle reti di telecomunicazione è
importante riuscire a prevedere il comportamento degli utenti e la
distribuzione del loro traffico in funzione dello stato della rete e
delle decisioni prese dai gestori della rete.

Tra i molti esempi di reti a cui potrebbe adattarsi il nostro modello
ne citiamo due molto diffusi: la \textbf{rete stradale} e la
\textbf{rete internet}. L'esperienza ci dice che non tutte le strade
che congiungono due località sono equivalenti: strade diverse potranno
avere tempi di percorrenza diversi (che potranno anche dipendere dal
traffico presente). Per questo ci servirà introdurre dei costi che,
nei nostri due esempi, si tradurranno in tempi di percorrenza (detti
anche \textit{latenze} nell'ambito della rete internet).

Vedremo alcuni modi in cui potrà disporsi il traffico sulle nostre
reti, il più importante è l'\textbf{equilibrio di Wardrop} che bene
esprime la volontà di ogni utente di minimizzare il proprio costo
arrivando all'equilibrio in cui ``non esistono scorciatoie''.

Infine vedremo anche, se pur in un modello molto semplificato, cosa
succede quando al tempo di percorrenza aggiungiamo anche il costo
economico fissato da uno o più fornitori che tentano di massimizzare
il proprio guadagno.

\section{Modello e instradamento socialmente ottimo}

\subsection{Modello}

Modellizziamo le nostre reti come grafi diretti dove per ogni arco è
data una funzione costo in funzione del traffico che attraversa l'arco
stesso (il costo è quindi una funzione ``locale'').

Supponiamo che le funzioni costo siano \textbf{continue}, \textbf{non
  negative} e \textbf{non decrescenti}. Quest'ultima ipotesi sulla
monotonia può essere giustificata dall'idea che le prestazioni di una
strada (o un collegamento) diminuiscono con l'aumentare del traffico.

Dato il traffico che deve attraversare la nostra rete, lo dividiamo in
base alle coppie ``sorgente-destinazione'' e indicizziamo queste
coppie con un qualche insieme $W$, descriviamo il traffico con tre
vettori: vettore delle sorgenti, vettore delle destinazioni e vettore
delle quantità di traffico da instradare.

Supponiamo tutto il traffico \textbf{infinitamente divisibile}, cioè
possiamo dividerlo sulle nostre strade in rapporti arbitrari. Questo
non è coerente con la realtà delle reti stradali e internet in cui il
traffico è discreto, ma ne descrive bene il comportamento quando la
quantità di utenti è sufficientemente grande.

Infine supponiamo che ci venga fornito per ogni coppia
``sorgente-destinazione'' l'insieme dei percorsi non contenenti cicli
che le congiungono. Questo ci permette di non dover trattare la
costruzione di questi insiemi (che comunque è un problema
semplice\footnote{Si veda, ad esempio,
  \url{https://xlinux.nist.gov/dads/HTML/allSimplePaths.html}}).

In figura \ref{fig:esempio-rete} si vede un esempio di rete.

\begin{figure}[ht]
  \centering
  \begin{tikzpicture}[mnode/.style={circle,fill=blue!20},>=latex]
    \node[mnode] (1) at (0,0) {1};
    \node[mnode] (2) at (2,2) {2};
    \node[mnode] (3) at (4,2) {3};
    \node[mnode] (4) at (3,-2) {4};
    \node[mnode] (5) at (6,0) {5};
    \draw [->] (1) to [bend left] (2);
    \node at (1,1) {$l_1(x_1)$};
    \draw [->] (2) to [bend right] (3);
    \node at (3,2.7) {$l_2(x_2)$};
    \draw [->] (3) to [bend right] (2);
    \node at (3,1.3) {$l_3(x_3)$};
    \draw [->] (3) to [bend left] (5);
    \node at (5.5,1.7) {$l_4(x_4)$};
    \draw [->] (1) to [bend right] (4);
    \node at (0.6,-1.7) {$l_5(x_5)$};
    \draw [->] (3) -- (4);
    \node at (4,0) {$l_6(x_6)$};
    \draw [->] (4) -- (2);
    \node at (2,0) {$l_7(x_7)$};
    \draw [->] (4) to [bend right] (5);
    \node at (5,-1) {$l_8(x_8)$};

    \node (S1) at (-2,0) {};
    \node (S2) at (-1,2) {};
    \node (T1) at (8,0) {};
    \node (T2) at (5.5,-2) {};
    \draw[->] (S1) -- node[above]{traffico 1} (1);
    \draw[->] (5) -- node[above]{traffico 1} (T1);
    \draw[->] (S2) -- node[above]{traffico 2} (2);
    \draw[->] (4) -- node[below]{traffico 2} (T2);
  \end{tikzpicture}
  \caption{Esempio di rete e traffico}
  \label{fig:esempio-rete}
\end{figure}

Formalizzando quanto appena detto, un'istanza del nostro problema è
data dalla seguente definizione:

\begin{mydef}[Istanza di instradamento]
  Un'\textbf{istanza di instradamento} (\textit{routing instance} o
  più brevemente \textbf{rete}) è $R=(V,A,P,s,t,X,l)$ con:
  \begin{itemize}
  \item $(V,A)$ il grafo diretto,
  \item $s = \bra{s_i}_{i\in W}$ vettore delle sorgenti (per un opportuno $W$),
  \item $t = \bra{t_i}_{i\in W}$ vettore delle destinazioni,
  \item $P = \cup _{i\in W} P_i$ con $P_i$ insieme dei
    percorsi da $s_i$ a $t_i$,
  \item $X = \bra{X_i}_{i\in W}$ dove $X_i$ rappresenta la quantità di
    traffico da instradare da $s_i$ a $t_i$,
  \item $l = \bra{l_j}_{j\in A}$ dove $l_j(x_j)$ è il costo dell'arco
    $j$ con un traffico $x_j$.
  \end{itemize}
  Supponiamo che le funzioni $l_j$ siano \textbf{non negative},
  \textbf{continue} e \textbf{non decrescenti}.
\end{mydef}

Chiamiamo $\mathcal{R}$ l'insieme di tutte le possibili istanze,
$\mathcal{R}^{aff}$ il sottoinsieme delle istanze con funzioni costo
affini, $\mathcal{R}^{conv}$ il sottoinsieme delle istanze con funzioni costo
convesse e $\mathcal{R}^{conc}$ il sottoinsieme delle istanze con
funzioni costo concave.

Per descrivere un possibile schema secondo cui il traffico può
disporsi utilizziamo due vettori: $\bra{x_j}_{j\in A}$ per descrivere
il traffico su ogni arco e $\bra{x_p}_{p\in P}$ per descrivere il
traffico su ogni percorso.

Questi due vettori (che esprimiamo come un unico vettore $x$)
descrivono un possibile schema se soddisfano la definzione di soluzione:

\begin{mydef}[Soluzione di un'istanza]
  Data un'istanza $R=(V,A,P,s,t,X,l)$ un vettore
  $x = \bra{x_j}_{j\in A} \cup \bra{x_p}_{p\in P}$ è \textbf{soluzione} se:
  \begin{itemize}
  \item instradiamo solo quantità non negative di traffico: \[ \forall p\in P\;\; x_p \ge 0\]
  \item il traffico su ogni arco è dato dalla somma del traffico di
    ogni percorso che lo attraversa: \[ \forall j\in A\;\; x_j = \sum_{p\in P,p\ni j} x_p\]
  \item la quantità di traffico instradata tra ogni coppia è proprio
    quella richiesta dal problema: \[\forall i\in W\;\; \sum_{p\in P_i} x_p = X_i\]
  \end{itemize}
\end{mydef}

Dato un percorso $p\in P$ e una soluzione $x$ possiamo scrivere il
costo pagato dagl'utenti instradati su quel percorso
come\footnote{Osserviamo che $l_p$ non dipende solo da $x_p$ ma da
  tutto il vettore $x$}:
\[ l_p\pa{x} = \sum _{j\in p} l_j\pa{x_j} \]
sommando il costo pagato su ogni percorso pesato sulla quantit\`a di
traffico di quel percorso otteniamo
\[ \sum _{p\in P} \pa{ x_p \sum _{j\in p} l_j\pa{x_j}}  = \sum _{j\in
    A} l_j\pa{x_j}x_j \]
questa quantit\`a rappresenta il costo pagato complessivamente dagli utenti.

\begin{mydef}[Costo globale di una soluzione]
\label{def:costo-globale}
  \[ C\pa{x} = \sum _{j\in A} l_j\pa{x_j}x_j \]  
\end{mydef}

\subsection{Instramento ottimo}
\label{sec:instramento-ottimo}

Data un'istanza $R$ ci chiediamo se esiste una soluzione che minimizza
il costo globale della soluzione.

\begin{mydef}[Instramento socialmente ottimo]
\label{def:soluzione-so}
  Chiamiamo \textbf{instradamento socialmente ottimo} di $R$ una
  soluzione che minimizza la funzione costo $C$. 
\end{mydef}

Trovare un instradamento socialmente ottimo equivale a risolvere il
seguente problema di minimizzazione:
\begin{align*}
      \text{minimizzare}\;\; & \sum _{j\in A} x_j l_j(x_j) \\
      \text{tale che}\;\; &   x_p \ge 0 & \forall p\in P \\
      & x_j = \sum_{p\in P,p\ni j} x_p & \forall j\in A \\
      &\sum_{p\in P_i} x_p = X_i & \forall i\in W
\end{align*}

\begin{mypro}
  La regione di spazio definita dai vincoli della definizione di
  soluzione \`e un poliedro convesso e compatto
\end{mypro}
\begin{proof}
  I vincoli sono tutti lineari e descrivono insiemi chiusi, quindi la
  regione \`e un poliedro chiuso, se dimostriamo che \`e anche
  limitato abbiamo la tesi.

  Fissato $i\in W$, sappiamo che per ogni $p'\in P_i$ si ha $x_{p'} \ge
  0$, quindi fissato $p\in P$ si ha
  \[ X_i = \sum _{p'\in P_i} x_{p'} \Rightarrow x_p \le X_i \]
  quindi per ogni $p\in P_i$ vale $0\le x_p \le X_i$ e quindi le
  variabili $\bra{x_p}_{p\in P}$ sono limitate.

  Fissato $j\in A$ si ha:
  \[ x_j = \sum _{p\ni j} x_p \ge 0 \]
  \[ x_j = \sum _{p\ni j} x_p \le \sum _{p\in P} x_p = \sum _{i\in W}
    \sum _{p\in P_i} x_p = \sum _{i\in W} X_i \]
  quindi per ogni $j\in A$ vale $0\le x_j \le \sum _{i\in W} X_i$ e
  quindi le variabili $\bra{x_j}_{j\in A}$ sono limitate.
\end{proof}

\begin{myteo}[Esistenza dell'instradamento ottimo]
  Data un'istanza $R$ esiste sempre almeno un instradamento ottimo.
\end{myteo}
\begin{proof}
  La funzione costo \`e somma di prodotto di funzioni continue, quindi
  \`e continua. I vincoli di soluzione formano un insieme
  compatto. Per il teorema di Weierstrass la funzione ammette minimo.
\end{proof}
\begin{myoss}
  La soluzione socialmente ottima pu\`o non essere unica (vedi
  l'esempio di figura \ref{fig:esempio-so-nonunica}), ma il suo costo
  globale lo \`e.
\end{myoss}
\begin{figure}[ht]
  \centering
  \begin{tikzpicture}[mnode/.style={circle,fill=blue!20},>=latex]
    \node[mnode] (1) at (0,0) {s};
    \node[mnode] (2) at (2,0) {t};
    \draw [->] (1) to [bend left] node[above] {1} (2);
    \draw [->] (1) to [bend right] node[below] {1} (2);
    \draw [->,color=red] (-1,0) to node[above] {1} (1);
    \draw [->,color=red] (2) to (3,0);
  \end{tikzpicture}  
  \caption{Esempio di rete in cui ogni soluzione \`e ottima}
  \label{fig:esempio-so-nonunica}
\end{figure}

Chiamiamo (con un leggero abuso di notazione) $x^{SO}\pa{R}$ una
soluzione socialmente ottima di $R$. Nonostante questo vettore non sia
ben definito, \`e ben definita la quantit\`a $C\pa{x^{SO}\pa{R}}$.

\begin{myes}[Esempio di Pigou]
  \label{es:esempio-pigou}
  Vediamo l'esempio di Pigou in Figura \ref{fig:esempio-pigou}.

  \begin{figure}[ht]
    \centering
    \begin{tikzpicture}[mnode/.style={circle,fill=blue!20,minimum size=0.65cm},>=latex,snode/.style={circle,fill=red!70}]
      \node[mnode] (1) at (0,0) {s}; 
      \node[mnode] (2) at (3,0) {t};
      \draw [->] (1) to [bend left] node[above] {$l_1(x) = x$} (2);
      \draw [->] (1) to [bend right] node[below] {$l_2(x) = 1$} (2);
      \draw [->,color=red] (-4,0) -- node[above] {1 unità di traffico} (1) ;
      \draw [->,color=red] (2) --  (5,0) ;
      \node at (7,0) {};
    \end{tikzpicture}
    \caption{Esempio di Pigou}
    \label{fig:esempio-pigou}
  \end{figure}
  
  Qui l'insieme dei percorsi coincide con l'insieme degl'archi, quindi
  possiamo usare solo un vettore di variabili $\bra{x_1, x_2}$.

  La funzione costo è: $C\pa{x} = x_1^2 + x_2$, aggiungendo la
  condizione $x_1 + x_2 = 1$ si ottiene
  \[ C\pa{x} = x_1 ^2 + 1 - x_1 \]
  il cui minimo si ottiene per
  \[ x^{SO}_1 = x^{SO}_2 = \frac{1}{2} \]
  abbiamo anche
  \[ C\pa{x^{SO}} = \frac{3}{4} \]

  Possiamo osservare che metà del traffico ha una latenza di
  $\frac{1}{2}$ mentre l'altra metà ha una latenza di $1$, quindi gli
  utenti stanno incontrando latenze diverse.
\end{myes}

\section{Instradamento di Wardrop}

\subsection{Motivazioni}
\label{sec:wardrop-motivazioni}

Vogliamo ora prevedere cosa succede quando gli utenti della nostra
rete decidono autonomamente quale percorso percorrere in modo da
massimizzare il proprio guadagno.

Abbiamo già osservato che nell'esempio di Pigou (esempio
\ref{es:esempio-pigou}) gli utenti incontreranno tempi di percorrenza
diversi, possiamo immaginare che in questo caso alcuni utenti
``furbi'' cercheranno di spostarsi sulla strada più veloce (anche al
costo di rallentarla) pur di ottenere un tempo di percorrenza minore.

Per descrivere come si comportano gli utenti quando cercano di
massimizzare il proprio guadagno (cioè quando diventano egoisti)
potremmo utilizzare la teoria dei giochi (vedi l'appendice
\ref{sec:teoria-giochi}) e, in particolare, cercare un equilibrio di
Nash di un qualche gioco costruito sulla rete.

Ricordiamo che un gioco è dato da
$\pa{\mathcal{I}, \pa{S_i}_{i\in\mathcal{I}},
  \pa{u_i}_{i\in\mathcal{I}}}$ dove $\mathcal{I}$ è l'insieme
\textbf{finito} dei giocatori.

Siccome abbiamo supposto il traffico infinitamente divisibile, non
possiamo costruire direttamente un gioco a partire dalla nostra rete,
abbiamo quindi tre strade:
\begin{enumerate}
\item definire direttamente un nuovo concetto di equilibrio su reti
  senza giustificarlo mediante la teoria dei giochi;
\item costruire \textbf{discretizzazioni} successive del traffico che
  approssimino il caso continuo, calcolare per ognuna di queste
  approssimazioni un equilibrio di Nash e farne un limite;
\item introdurre il concetto di \textbf{giochi non atomici} (ed il
  loro equilibrio di Nash) e applicare direttamente questa nuova
  teoria al nostro problema.
\end{enumerate}

Noi vedremo a grandi linee la seconda strada (discretizzare) ma senza
formalizzarla, poi nella sezione \ref{sec:wardrop-definizione} daremo
una definizione indipendente e formale (come previsto dal primo
metodo) di \textbf{equilibrio di Wardrop}.

L'idea è, quindi, di discretizzare il traffico in tante unità discrete
e omogenee e applicare un equilibrio di Nash. Supponiamo, per
semplicità, che tutto il traffico debba essere instradato tra un'unica
sorgente e un'unica destinazione.

\begin{myes}[Esempio di Pigou discretizzato]
\label{es:pigou-nash}
  Riprendiamo l'esempio di Pigou (vedi figura \ref{fig:esempio-pigou})
  dove abbiamo discretizzato il traffico a due unità (che saranno i
  nostri giocatori).

  Traducendo l'istanza nel formalismo della teoria dei giochi
  otteniamo:
  \begin{align*}
    \mathcal{I} &= \set{1,2} & S_1 = S_2 & = \set{\text{Link 1},
                                           \text{Link 2}}
  \end{align*}
  \begin{table}[!ht]
    \centering
    \begin{tabular}{rcc}
      & Link $1$ & Link $2$ \\
      \cline{2-3}
      Link $1$ & \multicolumn{1}{|c|}{$-1,-1$} & \multicolumn{1}{|c|}{$-0.5,-1$}  \\
      \cline{2-3}
      Link $2$ & \multicolumn{1}{|c|}{$-1,-0.5$} & \multicolumn{1}{|c|}{$-1,-1$}  \\
      \cline{2-3}
    \end{tabular}
    \caption{Funzioni guadagno $(u_1,u_2)$, le righe rappresentano la
      scelta del primo giocatore, le colonne la scelta del secondo}
    \label{tab:pigou-nash}
  \end{table}

  Si vede facilmente che per entrambi i giocatori scegliere
  \textit{Link 1} è una \textbf{strategia dominante}, quindi diciamo
  che la nuova soluzione è:
  \begin{align*}
    x^{N}_1 &= 1 & x^{N}_2 &= 0
  \end{align*}
  con un costo globale $C\pa{x^{N}} = 1$.
\end{myes}

Data un'istanza $R$ e una sua discretizzazione $R_n$, avremo
l'insieme dei giocatori $\mathcal{I} = \set{1,...,n}$ rappresentante
le singole unità di traffico con peso $m$, per ogni giocatore
l'insieme delle strategie disponibili è l'insieme $P$ dei percorsi e
le funzioni guadagno saranno
\[ u_i \pa{s} = u_i\pa{s_i, s_{-i}} = - \sum _{j\in s_i}
  l_j\pa{\sum_{s_k\ni j} m} = -\sum _{j\in s_i} l_j\pa{m + \sum_{s_k\ni
      j,k\neq i} m} \]
con $s = \bra{s_i}_{i\in\mathcal{I}} \in P^n$

Possiamo anche scrivere, per semplicità:
\[ u_i\pa{s_i, s_{-i}} = - \sum _{j\in s_i} l_j\pa{x_j\pa{s_i, s_{-i}}} \]
dove
\[ x_j\pa{s_i,s_{-i}} = \sum_{s_k\ni j} m = \left\{ 
    \begin{matrix}
      m + \sum_{s_k\ni j,k\neq i} m & \text{ se } j\in s_i \\
      \sum_{s_k\ni j,k\neq i} m & \text{ se } j\not\in s_i
    \end{matrix}
  \right.
\]

Dalla definizione, $s^*$ è un \textbf{equilibrio di Nash} per $R_n$ se
e solo se per ogni $i\in \mathcal{I}$ vale
\[ \forall p\in P \;\; u_i \pa{p,s^*_{-i}} \le u_i\pa{s^*_i,s^*_{-i}} \]

Per $n \to \infty$ avremo che $m\to 0$ e quindi
\[ x_j\pa{p, s^*_{-i}} \approx x_j\pa{s^*_i, s^*_{-i}} \]
cioè la scelta di un singolo giocatore al limite non influenza il
flusso di ogni arco. Ricordando che le funzioni $l_j$ sono continue si
ottiene che
$l_j\pa{x_j\pa{p, s^*_{-i}}} \approx l_j\pa{x_j\pa{s^*_i, s^*_{-i}}}$
da cui:
\[ u_i\pa{p, s^*_{-i}} \approx - \sum_{j\in p} l_j\pa{x_j\pa{s^*_i,
      s^*_{-i}}} = -\sum _{j\in p}l_j\pa{x^*_j} \]

La condizione dell'equilibrio di Nash si può quindi riscrivere come:
\[ \forall p\in P\;\;\; \sum _{j\in s_i}l_j\pa{x^*_j} \le \sum _{j\in
    p}l_j\pa{x^*_j} \]
osservando che $x_p > 0 \Leftrightarrow \exists i\in \mathcal{I}:\;
s^*_i = p$ otteniamo che al limite
\[ \forall x_p >0, \forall p'\in P \;\;\; \sum _{j\in p}l_j\pa{x^*_j}
  \le \sum _{j\in p'}l_j\pa{x^*_j} \]
cioè \textbf{i percorsi scelti sono quelli che minimizzano il tempo di
  percorrenza}, inoltre se anche $x_{p'} > 0$ la relazione vale con il
segno di uguaglianza (basta scambiare il ruolo delle variabili).

Questo ci porta al primo criterio proposto da
Wardrop\cite[pag. 345]{wardrop1952} per determinare la distribuzione
del traffico: \textit{Il tempo di percorrenza di tutte le strade
  veramente usate è uguale, inoltre è più piccolo di quello che
  impiegherebbe un singolo veicolo a percorrere una strada non
  utilizzata}

Il ragionamento che abbiamo seguito, oltre a non essere ben
formalizzato, non tiene in considerazione il problema che l'equilibrio
di Nash potrebbe non esistere per ogni $n$ e quando esiste potrebbe
non essere unico. Inoltre non abbiamo gestito in alcun modo il
passaggio al limite che potrebbe non sempre essere fattibile.

In alcuni casi è possibile formalizzare questo ragionamento ottenendo,
ad esempio, il seguente teorema:
\begin{myteo}[{\cite[Teorema 3.2]{haurie1985}}]
  Sia $R\in \mathcal{R}$ un'istanza e $\pa{R_n}_{n\in \mathbb{N}}$ una
  successione di approssimazioni discrete di $R$, se per ogni $n$
  esiste un equilibrio di Nash per $R_n$ e se le funzioni costo $l_j$
  sono strettamente crescenti, allora esiste un'unica soluzione $x$
  che rispetta il criterio di Wardrop\footnote{Cioè soddisfa le
    richieste della definizione \ref{def:wardrop}} e tale che per ogni
  sequenza $x_n$ di soluzioni associate ad un equilibrio di Nash si ha
  \[ \lim _{n\to \infty} x_n = x^* \]
\end{myteo}

\subsection{Definizione e esistenza}
\label{sec:wardrop-definizione}

Formalizziamo il principio di Wardrop nel caso generale, applicando il
principio di Wardrop ad ogni coppia sorgente-destinazione otteniamo la
seguente definizione:
\begin{mydef}[Equilibrio di Wardrop]
  \label{def:wardrop}
  Una soluzione $x$ di $R\in \mathcal{R}$ è un \textbf{equilibrio di
    Wardrop} se per ogni coppia sorgente-destinazione $(s_i,t_i)$
  (cioè per ogni $i\in W$) vale:
  \begin{align*}
    \sum _{j\in p'} l_j(x_j) &= \sum _{j\in p} l_j(x_j) & \forall
                                                           p,p'\in P_i \text{ con } x_p >0, x_{p'} >0 \\
    \sum _{j\in p'} l_j(x_j) &\ge \sum _{j\in p} l_j(x_j) & \forall
                                                             p,p'\in P_i \text{ con } x_p >0, x_{p'} =0 
  \end{align*}
  indichiamo con $x^{WE}(R)$ una tale soluzione.
\end{mydef}

Osserviamo che due coppie sorgente-destinazione differenti potrebbero
avere tempi di percorrenza diversi.

Vediamo ora alcuni teoremi che ci assicurano l'esistenza di un
equilibrio di Wardrop. Come nel caso della soluzione socialmente
ottima questo equilibrio non sarà in generale unico (quindi la
notazione $x^{WE}(R)$ non sarebbe ben definita), ma il costo di tale
soluzione lo sarà (e quindi la quantità $C\pa{x^{WE}\pa{R}}$ sarà ben
definita).

\begin{myteo}[Beckmann, McGuire and Winsten]
  Data un'istanza $R\in \mathcal{R}$, una soluzione $x$ è un equilibrio di
  Wardrop per $R$ se e solo se $x$ è un punto di minimo del problema
  \begin{align*}
    \text{minimizzare} \;&  \sum _{j\in A} \int _0 ^ {x_j}
                           l_j(z)\de z \\
    \text{con} \;& \sum _{p\in P, p\ni j} x_p = x_j&\forall j\in
                                                     A\\
                         & \sum _{p\in P_i} x_p = X_i& \forall i\in W\\
                         & x_p \ge 0&\forall p\in P        
  \end{align*}
\end{myteo}
\begin{proof}
  Scriviamo le funzioni:
  \begin{align*}
    f(x) &= \sum _{j\in A} \int _0 ^ {x_j} l_j(z)\de z \\
    g_p(x) &= -x_p & \forall p\in P \\
    h_j(x) &= \sum _{p\ni j} x_p -x_j & \forall j\in A\\
    t_i(x) &= \sum _{p\in P_i} x_p - X_i & \forall i\in W
  \end{align*}
  
  Il problema diventa
  \begin{align*}
    \text{minimizzare} \;&  f(x) \\
    \text{con} \;& g_p(x) \le 0 &\forall p \in P \\
                         & h_j(x) = 0 & \forall j\in A\\
                         & t_i(x) = 0 & \forall i\in W
  \end{align*}

  Abbiamo supposto all'inizio le $l_j$ non decrescenti, quindi $f$ è
  una funzione convessa. Inoltre i vincoli sono tutti lineari, quindi
  (per un teorema visto a lezione) $x$ è punto di minimo se e solo se
  valgono le condizioni di Karush–Kuhn–Tucker in $x$.

  Le KKT in $x$ si scrivono come $\exists \lambda \in \mathbb{R}_+^{\abs{P}}$,
  $\exists \mu \in \mathbb{R}^{\abs{A}}$,
  $\exists \theta \in \mathbb{R}^{\abs{W}}$ tali che:
  \[ 0 = \nabla f(x) + \sum_{p\in P}\lambda _p \nabla g_p(x) + \sum _{j\in
      A} \mu _j \nabla h_j(x) + \sum _{i\in W} \theta _i \nabla t_i(x) \]
  \[ \forall p\in P\;\; \lambda _p g_p(x) = 0 \]
  
  Scrivendo le condizioni componente per componente otteniamo:
  \begin{align*}
    l_j(x_j) - \mu _j =0 && \forall j\in A \\
    -\lambda _p + \sum _{j\in p}\mu _j + \theta _i =0 && \forall p \in
                                                      P _i \\
    \lambda _p x_p =0 && \forall p\in P
  \end{align*}
  la condizione di complementarietà può essere riscritta come $x_p > 0
  \rightarrow \lambda _p =0$, le altre come:
  \begin{align*}
    l_j(x_j) = \mu _j && \forall j\in A \\
    \sum _{j\in p}l_j(x_j) = -\theta _i + \lambda _p && \forall p \in
                                                      P _i
  \end{align*}
  dalla seconda utilizzando la complementarietà degli scarti si
  ottiene:
  \begin{align*}
    \forall p\in P_i,\;\; x_p > 0 & \Rightarrow \sum _{p\ni j} l_j(x_j) = -\theta _i \\
    \forall p\in P_i,\;\; x_p = 0 & \Rightarrow \sum _{p\ni j} l_j(x_j) \ge -\theta _i
  \end{align*}
  queste sono proprio le condizioni di Wardrop dove la quantità
  $-\theta _i$ rappresenta proprio la minima lunghezza effettiva di un
  percorso tra $s_i$ e $t_i$.
\end{proof}
\begin{mycor}
  Data un'istanza $R\in \mathcal{R}$ esiste sempre un equilibrio di
  Wardrop per $R$, inoltre se tutte le funzioni costo di $R$ sono
  strettamente crescenti allora tale equilibrio è unico.
\end{mycor}
\begin{proof}
  Per il teorema precedente il problema dell'equilibrio di Wardrop è
  equivalente ad un problema di minimizzazione convessa (dove
  l'insieme definito dai vincoli è compatto), quindi esiste sempre una
  soluzione.

  Nel caso in cui le funzioni costo siano strettamente crescenti la
  funzione obiettivo del problema equivalente è strettamente convessa
  e quindi la soluzione sarà unica.
\end{proof}

\begin{myteo}
  Il costo globale dell'equilibrio di Wardrop è unico, quindi è ben
  definita la quantità $C\pa{x^{WE}\pa{R}}$.
\end{myteo}
\begin{proof}
  Abbiamo visto che $x$ è un equilibrio di Wardrop se e solo se è
  minimo (vincolato) della funzione $f(x) = \sum _{j\in A} \int _0
  ^{x_j} l_j(z)\de z$, abbiamo anche visto che la funzione $f$ è
  convessa.

  Sia $L_j(x_j) = \int _0 ^{x_j} l_j(z)\de z$, queste sono tutte
  funzioni convesse per le ipotesi sulle funzioni $l_j$.

  Siano $x,y$ due punti di minimo vincolati di $f$, per la convessità
  sappiamo che per ogni $t\in\bra{0,1}$ si ha
  \[ f\pa{ tx + (1-t)y} \le tf(x) + (1-t)f(y) \]
  ma in realtà questa relazione vale con l'uguaglianza perché
  $f(x)=f(y)$ è il valore minimo di $f$.

  Ricordando che anche le $L_j$ sono convesse, quindi possiamo
  scrivere:
  \begin{align*}
    f\pa{ tx + (1-t)y} & = \sum _{j\in A} L_j\pa{tx_j + (1-t)y_j} \\
    & \le \sum _{j\in A} \pa{ tL_j(x_j) + (1-t)L_j(y_j)} \\
    & = t \sum _{j\in A} L_j(x_j) + (1-t)\sum _{j\in A} L_j(y_j) \\
    & = tf(x) + (1-t)f(y)
  \end{align*}
  ricordando l'equazione precedente si può dedurre che per ogni $j\in
  A$ si ha
  \[ L_j\pa{tx_j + (1-t)y_j} = tL_j(x_j) + (1-t)L_j(y_j) \]
  quindi le $L_j$ sono lineari in $\bra{x_j,y_j}$, ma questo accade se
  e solo se le $l_j$ sono costanti negli stessi intervalli.

  Quindi per ogni $j\in A$ abbiamo $l_j(x) = l_j(y)$, quindi per ogni
  $p\in P$ si ha
  \[ \sum _{j\in p} l_j\pa{x_j} = \sum _{j\in p} l_j\pa{y_j} \]
  
  Dati due percorsi $p,p'\in P_i$ tali che $x_p>0$ e $y_{p'}>0$ possiamo
  applicare la seconda condizione dell'equilibrio di Wardrop nei due
  versi ottenendo
  \[ \sum _{j\in p} l_j\pa{x_j} = \sum _{j\in p'} l_j\pa{y_j} \]
  
  Osserviamo ora che il costo globale per un equilibrio di Wardrop si
  può scrivere come:
  \[ C\pa{x} = \sum _{p\in P} \pa{ x_p \sum _{j\in p} l_j\pa{x_j}} =
    \sum _{i\in W} \bra{ \sum _{p\in P_i} \pa{ x_p \sum _{j\in p_i}
        l_j\pa{x_j}} } = \sum _{i\in W} \pa{ X_i \sum _{j\in p_i}
      l_j\pa{x_j}} \]
  dove $p_i\in P_i$ è un percorso tale che $x_{p_i} > 0$.

  Scrivendo la stessa formula per $C\pa{y}$ e sostituendo le relazioni
  precedentemente trovate si ha la tesi.
\end{proof}

\begin{myes}[Esempio di Pigou]
  Applicando l'equilibrio di Wardrop all'esempio di Pigou (vedi
  esempio \ref{es:esempio-pigou}) si ottiene la soluzione:
  \begin{align*}
    x^{WE}_1 &= 1 & x^{WE}_2 &= 0 & C\pa{x^{WE}} &= 1
  \end{align*}
  che coincide con la soluzione calcolata dall'equilibrio di Nash nel
  caso discretizzato.

  Osserviamo, infine, che il costo globale della soluzione $x^{WE}$ è
  maggiore del costo della soluzione socialmente ottima.
\end{myes}

\subsection{Inefficienza dell'equilibrio di Wardrop}
\label{sec:wardrop-inefficienza}

\subsubsection{Prezzo dell'anarchia}
\label{sec:wardrop-poa}

Abbiamo già visto nell'esempio di Pigou che il costo globale della
soluzione di Wardrop può essere maggiore del costo della soluzione
ottima, siamo quindi interessati a studiare la quantità (che
chiameremo \textbf{prezzo dell'anarchia})
\[ \frac{C\pa{x^{SO}\pa{R}}}{C\pa{x^{WE}\pa{R}}} \]
al variare di $R$ in opportuni sottoinsiemi di $\mathcal{R}$. Lo
studio di questa quantità, in particolare del suo minimo, ci dirà di
quanto l'equilibrio di Wardrop può peggiorare il costo rispetto alla
soluzione ottima.

\begin{myteo}[Roughgarden e Tardos{\cite[Teorema
    4.5]{roughgarden2002}}]
\label{teo:roughgarden-tardos}
  \[ \inf _{R\in \mathcal{R}^{conv}} \frac{C\pa{ x^{SO}\pa{R}}}{C\pa{
        x^{WE}\pa{R}}} = 0 \]
  \[ \inf _{R\in \mathcal{R}^{aff}} \frac{C\pa{ x^{SO}\pa{R}}}{C\pa{
        x^{WE}\pa{R}}} = \frac{3}{4} \]
\end{myteo}

È possibile dimostrare anche una versione più forte del secondo punto
\begin{myteo}[{\cite[Lemma 3.10]{menache2011network}}]
\label{teo:poa-we-conc}
  \[ \inf _{R\in \mathcal{R}^{conc}} \frac{C\pa{ x^{SO}\pa{R}}}{C\pa{
        x^{WE}\pa{R}}} = \frac{3}{4} \]
\end{myteo}

Non dimostraiamo quest'ultimo teorema (una dimostrazione si può
trovare nel testo citato) e dimostriamo solo la prima
parte del teorema di Roughgarden e Tardos (la seconda è un corollario
del teorema \ref{teo:poa-we-conc}).

\begin{proof}[Dimostrazione della prima parte del teorema \ref{teo:roughgarden-tardos}]
  Per dimostrare questa parte del teorema ci basta esibire una
  successione di istanze $\pa{R_k}_{k\in \mathbb{N}}$ tali che $R_k\in
  \mathcal{R}^{conv}$ e
  \[ \lim _{k\to \infty} \frac{C\pa{ x^{SO}\pa{R_k}}}{C\pa{
x^{WE}\pa{R_k}}} = 0 \]

  \begin{figure}[ht]
    \centering
    \begin{tikzpicture}[mnode/.style={circle,fill=blue!20,minimum size=0.65cm},>=latex,snode/.style={circle,fill=red!70}]
      \node[mnode] (1) at (0,0) {s}; 
      \node[mnode] (2) at (3,0) {t};
      \draw [->] (1) to [bend left] node[above] {$l_1(x_1) = x_1^k$} (2);
      \draw [->] (1) to [bend right] node[below] {$l_2(x_2) = 1$} (2);
      \draw [->,color=red] (-1,0) -- node[above] {1} (1) ;
      \draw [->,color=red] (2) --  (4,0) ;
    \end{tikzpicture}
    \caption{Istanza $R_k$}
    \label{fig:esempio-conv-poa}
  \end{figure}

  Sia $R_k$ l'istanza costituita come in figura
  \ref{fig:esempio-conv-poa} (differisce dall'esempio di Pigou per la
  funzione $l_1$), come abbiamo già osservato precendentemente ci
  bastano le variabili $x_1$ e $x_2$ (rispettivamente il traffico sul
  primo e sul secondo arco) per descrivere l'instradamento (l'insieme
  degli archi coincide con l'insieme dei percorsi).
  
  I vincoli sono:
  \begin{align*}
    x_1 &\ge 0 & x_2 &\ge 0 & x_1 + x_2 &= 1
  \end{align*}
  le funzioni da minimizzare
  \begin{align*}
    f^{SO}(x) &= x_1^{k+1} + x_2 & f^{WE}(x) &= \frac{x_1^{k+1}}{k+1}
                                              + x_2
  \end{align*}
  
  Senza dover minimizzare $f^{WE}$ si può vedere che nell'equilibrio
  di Wardrop tutto il traffico viene instradato nel primo link,
  infatti in qualunque soluzione con $x_2>0$ si avrebbe $x_1<1$ da cui
  $l_1(x_1) < 1 = l_2(x_2)$ e quindi non potrebbe essere un equilibrio
  di Wardrop. Quindi:
  \begin{align*}
    x^{WE}_1 &= 1 & x^{WE}_2 &= 0 & C\pa{x^{WE}} = 1
  \end{align*}

  Riscrivendo $f^{SO}$ eliminando $x_2$ (con il terzo vincolo) si ha
  \[ f^{SO}(x) = x_1^{k+1} - x_1 + 1 \]
  questa funzione per $x_1\ge 0$ ha un unico punto di minimo in $x_1 =
  \pa{k+1}^{-1/k}$, la soluzione corrispondente rispetta i vincoli e
  quindi è la soluzione cercata
  \begin{align*}
    x^{SO}_1 &= \pa{k+1}^{-1/k} & x^{SO}_2 &= 1- \pa{k+1}^{-1/k} &
    C\pa{x^{SO}} &= 1 - \frac{k}{k+1}\pa{k+1}^{-1/k} 
  \end{align*}
  
  Calcolando il limite si vede che la successione si comporta come
  richiesto:
  \[ \lim _{k\to \infty} \frac{C\pa{ x^{SO}\pa{R_k}}}{C\pa{
        x^{WE}\pa{R_k}}} = 1 - \lim _{k\to \infty}
    \frac{k}{k+1}\pa{k+1}^{-1/k} = 0 \]
\end{proof}

\subsubsection{Paradosso di Braess}
\label{sec:paradosso-braess}

Un altro comportamento inefficiente dell'equilibrio di Wardrop è dato
dall'esempio del paradosso di Braess

\begin{myes}[Paradosso di Braess{\cite[pag. 263]{braess1968}}]
\label{es:braess}
  Consideriamo un'istanza come in figura \ref{fig:braess-prima}, qui
  la disposizione del traffico secondo l'equilibrio di Wardrop
  coinciderà con la disposizione della soluzione socialmente
  ottima. Il costo globale di entrambe le soluzioni sarà $3/2$.
  \begin{figure}[ht]
    \centering
    \begin{tikzpicture}[mnode/.style={circle,fill=blue!20,minimum size=0.65cm},>=latex,snode/.style={circle,fill=red!70}]
      \node[mnode] (0) at (0,0) {0}; 
      \node[mnode] (1) at (3,2) {1};
      \node[mnode] (2) at (3,-2) {2};
      \node[mnode] (3) at (7,0) {3};
      \draw [->] (0) to node[below] {x} (1);
      \draw [->] (0) to node[above] {1} (2);
      \draw [->] (1) to node[below] {1} (3);
      \draw [->] (2) to node[above] {x} (3);
      \draw [->,color=red] (-1,0) -- node[above,color=black] {1} (0) ;
      \draw [->,color=red] (0) to [bend left] node[above,color=red]{$1/2$} (1);
      \draw [->,color=red] (0) to [bend right] node[below,color=red]{$1/2$} (2);
      \draw [->,color=red] (1) to [bend left] node[above,color=red]{$1/2$} (3);
      \draw [->,color=red] (2) to [bend right] node[below,color=red]{$1/2$} (3);
      \draw [->,color=red] (3) -- (8,0) ;
    \end{tikzpicture}
    \caption{Paradosso di Braess: prima di aggiungere la nuova strada}
    \label{fig:braess-prima}
  \end{figure}

  Supponiamo ora di voler ``migliorare'' la rete aggiungendo un nuovo
  arco tra il nodo 1 e il nodo 2 con costo $0$ (vedi figura
  \ref{fig:braess-dopo}). Potremmo pensare che, essendo un
  miglioramento, il costo del nuovo equilibrio debba essere minore o
  uguale a quello del vecchio equilibrio.

  \begin{figure}[ht]
    \centering
    \begin{tikzpicture}[mnode/.style={circle,fill=blue!20,minimum size=0.65cm},>=latex,snode/.style={circle,fill=red!70}]
      \node[mnode] (0) at (0,0) {0}; 
      \node[mnode] (1) at (3,2) {1};
      \node[mnode] (2) at (3,-2) {2};
      \node[mnode] (3) at (7,0) {3};
      \draw [->] (0) to node[below] {x} (1);
      \draw [->] (0) to node[above] {1} (2);
      \draw [->] (1) to node[below] {1} (3);
      \draw [->] (2) to node[above] {x} (3);
      \draw [->,color=red] (-1,0) -- node[above,color=black] {1} (0) ;
      \draw [->,color=white] (0) to [bend left] node[below,color=blue]{$1/2$} (1);
      \draw [->,color=white] (0) to [bend right] node[above,color=blue]{$1/2$} (2);
      \draw [->,color=white] (1) to [bend left] node[below,color=blue]{$1/2$} (3);
      \draw [->,color=white] (2) to [bend right] node[above,color=blue]{$1/2$} (3);
      \draw [->] (1) to node[left] {0} (2);
      \draw [->,color=red,line width=1.5pt] (1) to [bend left] node[right,color=red]
      {1} (2);
      \draw [->,color=red,line width=1.5pt] (0) to [bend left] node[above]{$1$} (1);
      \draw [->,color=red,line width=1.5pt] (2) to [bend right] node[below]{$1$} (3);
      \draw [->,color=red,line width=1.5pt] (-1,0) -- (0) ;
      \draw [->,color=red,line width=1.5pt] (3) -- (8,0) ;
    \end{tikzpicture}

    \caption{Paradosso di Braess: dopo aver aggiunto la nuova strada,
      in rosso il traffico dell'equilibrio di Wardrop, in blu quello
      della soluzione ottima}
    \label{fig:braess-dopo}
  \end{figure}

  In effetti la soluzione ottima non è modificata (quindi il costo non
  è peggiorato), ma calcolando l'equilibrio di Wardrop si vede che
  tutto il traffico segue il percorso 0 -- 1 -- 2 -- 3 e il costo
  globale diventa $2$.
\end{myes}

Come abbiamo visto nell'esempio, migliorare la qualità dei
collegamenti di una rete potrebbe peggiorare il costo incontrato dagli
utenti. Vogliamo definire in modo più formale questa situazione, per
farlo ci serve prima la definizione di sottorete.

\begin{mydef}[Sottorete]
\label{def:sottorete}
  Data un'istanza $R=(V,A,P,s,t,X,l)$ diciamo che
  $R_0=(V_0,A_0,P_0,s_0,t_0)$ è una \textbf{sottorete} di $R$ se:
  \begin{enumerate}
  \item $V_0 \subseteq V$ e $A_0 = A \cap \pa{V_0\times V_0}$,
  \item esistono due nodi $s_0,t_0\in V$ tali che tutti i percorsi di
    $P$ passanti per $\pa{V_0,A_0}$ contengono un percorso in $P_0$ da
    $s_0$ in $t_0$ sugl'archi di $A_0$.
  \end{enumerate}
  Scriviamo $R_0\subseteq R$.
\end{mydef}

Osserviamo che la seconda richiesta della definizione fa sì che la
rete abbia \textbf{un unico punto di accesso e un unico punto di
  uscita}, questo significa che ogni percorso passante per gli archi
di $R_0$ deve entrare in $R_0$ attraverso $s_0$ e uscire tramite
$t_0$.

\begin{figure}[ht]
  \centering
      \begin{tikzpicture}[mnode/.style={circle,fill=blue!20,minimum size=0.65cm},>=latex,snode/.style={circle,fill=red!70},rnode/.style={circle,fill=green!50,minimum size=0.65cm}]
      \node[mnode] (0) at (0,0) {$s$};
      \node[mnode] (1) at (2,0) {};
      \node[mnode] (2) at (3.7,-1) {};
      \node[mnode] (3) at (6,0) {$t$};
      \node[rnode] (4) at (2,-2) {$s_0$};
      \node[rnode] (5) at (5,-2) {$t_0$};
      \node[rnode] (6) at (3,-3) {};
      \node[rnode] (7) at (4,-3) {};
      \draw [->] (0) to (1);
      \draw [->] (1) to (2);
      \draw [->] (2) to (3);
      \draw [->] (1) to (3);
      \draw [->] (0) to (4);
      \draw [->] (2) to (3);
      \draw [->] (1) to (4);
      \draw [->] (5) to (3);
      \draw [->] (4) to (2);
      \draw [->] (2) to (5);
      \draw [->,color=green] (4) to (5);
      \draw [->,color=green] (4) to (6);
      \draw [->,color=green] (6) to (7);
      \draw [->,color=green] (7) to (5);
      \draw [->,color=green] (6) to (5);
      \draw [->,color=red] (-1,0) -- (0) ;
      \draw [->,color=red] (3) -- (7,0) ;
    \end{tikzpicture}
  \caption{Esempio di sottorete: i nodi e gli archi verdi
    rappresentano la sottorete.}
  \label{fig:sottorete}
\end{figure}

Siamo ora pronti a definire cos'è un paradosso di Braess.
\begin{mydef}[Paradosso di Braess]
  Data una rete $R=(V,A,P,s,t,X,l)$ e una sua sottorete
  $R_0=(V_0,A_0,P_0,s_0,t_0)$ diciamo che esiste un
  \textbf{paradosso di Braess} in $R$ centrato in $R_0$ se esiste
  un'altra istanza nella forma $R_m=(V,A,P,s,t,X,m)$ tale che:
  \begin{enumerate}
    \begin{minipage}{1.0\linewidth}
    \item $\forall j\in A$ e $\forall x_j \ge0$
      \begin{itemize}
      \item $j \in A_0 \longrightarrow m_j(x_j) \le l_j(x_j)$,
      \item $j \not\in A_0\longrightarrow m_j(x_j) = l_j(x_j)$;
      \end{itemize}
    \end{minipage}
  \item $C\pa{x^{WE}\pa{R_m}} > C\pa{x^{WE}\pa{R}}$.
  \end{enumerate}
\end{mydef}

Nell'esempio \ref{es:braess} la sottorete in cui esiste il paradosso è
l'arco 1--2 che inizialemente ha costo $+\infty$ e poi viene
migliorato facendolo passare a $0$.

\section{Instradamento parzialmente ottimo}

\subsection{Modello e soluzione}
\label{sec:por-modello}

Vogliamo analizzare ora reti in cui alcune porzioni sono gestite da
degli operatori che controllano completamente il traffico nella loro
porzione di rete.

Data un'istanza $R\in \mathcal{R}$ supponiamo che ci siano $k$
sottoreti \textbf{disgiunte} $R_1,...,R_k \subseteq R$ controllate da
diversi operatori. Ricordiamo che nella definizione
\ref{def:sottorete} (sottorete) abbiamo supposto che ogni sottorete
abbia un unico punto di ingresso e un unico punto di uscita.

Per semplicità supponiamo che ci sia un unico operatore e, quindi,
un'unica sottorete $R_0 \subseteq R$.

Nella soluzione che vogliamo definire l'operatore, avendo il pieno
controllo della sua sottorete, instraderà in modo ottimo il traffico
che lo attraversa, il resto della rete continuerà ad utilizzare
l'equilibrio di Wardrop.

Data $R=(V,A,P,s,t,X,l)$ e $R\supseteq R_0 =(V_0,A_0,P_0,s_0,t_0)$
consideriamo, al variare di $X_0\in \mathbb{R}^+$, la rete
\[ R_0\pa{X_0} = \pa{V_0,A_0,P_0,\bra{s_0},\bra{t_0},\bra{X_0},
    l_{\mid A_0}} \]
si ha che $R_0\pa{X_0}\in \mathcal{R}$, quindi possiamo calcolarne una
soluzione socialmente ottima e definire (per $X_0>0$) la quantità
\[ L_0\pa{X_0} = C\pa{x^{SO}\pa{R_0\pa{X_0}}} \]
\begin{mydef}[Latenza effettiva]
  Chiamiamo \textbf{latenza effettiva} di $R_0 \subseteq R$ la
  funzione
  \[ l_0\pa{X_0} = \left\{
      \begin{matrix}
        \frac{L\pa{X_0}}{X_0} & \text{ per } X_0 > 0 \\
        \lim _{x\to 0} l_0\pa{x_0} & \text{ per } X_0 = 0
      \end{matrix}
    \right. \]
\end{mydef}
\begin{mylem}
\label{lem:l0-regolare}
  La funzione $l_0$ così definita è continua, non negativa e non
  decrescente.
\end{mylem}
\begin{proof}
  Dimostriamo la proprietà su $\pa{0,+\infty}$.

  La funzione costo globale $C$ è somma di termini del tipo $x_j
  l_j(x_j)$ che sono non negativi per definizione di soluzione e di
  istanza, quindi la funzione $L_0$ è non negativa e di conseguenza è
  non negativa la funzione $l_0$.

  Osservo che la funzione $C$ ha la seguente proprietà per ogni $x$
  soluzione e per ogni $\lambda \le 1$:
  \[ C\pa{\lambda x} = \sum _{j\in A} \lambda x_j l_j\pa{\lambda x_j}
    = \lambda \sum _{j\in A} l_j\pa{\lambda x_j} \le \lambda \sum
    _{j\in A} l_j\pa{ x_j} = \lambda C\pa{x} \]

  Siano $a,b\in \pa{0,+\infty}$ tali che $a<b$ e siano $x^a$ e $x^b$
  delle soluzioni socialmente ottime rispettivamente di $R_0\pa{a}$ e
  $R_0\pa{b}$. Considero ora il vettore
  \[ \frac{a}{b} x^b \le x^b \]
  (dove le operazioni e i confronti vanno intese componente per
  componente), si vede facilmente che questo vettore è una soluzione
  di $R_0(a)$, in generale non sarà una soluzione socialmente ottima.

  Si ha:
  \[ L_0\pa{a} = C\pa{x^a} \le C\pa{\frac{a}{b} x^b} \le \frac{a}{b}
    C\pa{x^b} = \frac{a}{b}L_0\pa{b} \]
  quindi:
  \[ l_0(a) = \frac{L_0(a)}{a} \le \frac{\frac{a}{b} L_0(b)}{a}
    =\frac{L_0(b)}{b} = l_0(b) \]
  
  Data la non decrescenza, per dimostrare la continuità ci basta
  dimostrare che per ogni $\bar X\in \pa{0,\infty}$ vale
  $\lim _{X\to \bar X^+} l_0\pa{X} \le l_0\pa{\bar X}$ che equivale a
  \[ \lim _{\lambda \to 1^+} L_0\pa{\lambda \bar X} \le
    L_0\pa{\bar X} \] chiamiamo $\bar x$ una soluzione socialmente
  ottima di $R_0\pa{\bar X}$.
  
  Per $\lambda > 1$ il vettore $\lambda \bar x$ è una soluzione (non
  necessariamente ottima) di $R\pa{\lambda \bar X}$, quindi
  \[ L_0\pa{\lambda \bar X} \le C\pa{\lambda \bar x} = \sum _{j\in A}
    \lambda \bar x_j l_j(\lambda \bar x_j) \]
  passando al limite e ricordando che le funzioni $l_j$ sono continue
  si ottiene:
  \[ \lim _{\lambda \to 1^+} L_0\pa{\lambda \bar X} \le \lim _{\lambda
      \to 1^+} \sum _{j\in A}\lambda \bar x_j l_j\pa{\lambda \bar x_j}
    = \sum _{j\in A} \bar x_j l_j\pa{\bar x_j} = C\pa{\bar x} =
    L_0\pa{\bar X} \]

  Abbiamo dimostrato le proprietà su $\pa{0,+\infty}$, il limite per
  $X_0 \to 0$ è ben definito per la non decrescenza. La continuità e
  la non negatività sono ovvie per la definizione di $l_0\pa{0}$.
\end{proof}

\begin{mylem}[{\cite[Lemma 3.11]{menache2011network}}]
  \label{lem:l0-concava}
  Sia $R\in \mathcal{R}^{aff}$ un'istanza e $R_0\subseteq R$ una
  sottorete, allora la funzione $l_0$ è concava.
\end{mylem}
\begin{proof}
  Per ipotesi per ogni $j\in A_0$ possiamo scrivere $l_j\pa{x_j} = a_j
  x_j + b_j$ con $a_j\ge 0$ (per la non decrescenza) e $b_j \ge 0$
  (per la non negatività). Scriviamo il problema della soluzione
  ottima:
  \begin{align*}
    l_0(X_0) = & \min _{x_p \ge 0, p\in P_0}  \sum _{j\in A_0} \pa{
                 \frac{a_j x_j ^2}{X_0} + \frac{b_j x_j}{X_0}} \\
    \text{tale che } & \sum _{p\in P_0, p\ni j} x_p = x_j & \forall j\in A_0
    \\
    & \sum _{p\in P_0} x_p = X_0
  \end{align*}

  Sostituiamo $y_p = \frac{x_p}{X_0}$ e $y_j = \frac{x_j}{X_0}$,
  otteniamo il seguente problema:
  \begin{align*}
    l_0(X_0) = & \min _{y_p \ge 0, p\in P_0}  \sum _{j\in A_0} \pa{
                 a_j X_0 y_j ^2 + b_j y_j} \\
    \text{tale che } & \sum _{p\in P_0, p\ni j} y_p = y_j & \forall j\in A_0
    \\
    & \sum _{p\in P_0} y_p = 1
  \end{align*}
  definiamo quindi la regione $Y$ come:
  \[ Y = \set { y \mid y_p \ge 0\; \forall p \in P_0, \; \sum _{p\in
        P_0} = 1 } \]
  abbiamo così
  \[ l_0\pa{X_0} = \inf _{y\in Y} \bra{ \pa{ \sum _{j\in A_0} a_j
        y_j^2} X_0 + \pa { \sum _{j\in A_0} b_j y_j} } \]
  cioè la funzione $l_0$ è l'estremo inferiore di una famiglia di
  funzioni affini, quindi è concava.
\end{proof}

Definiamo ora una nuova istanza $R'$ ricavata da $R$ sostituendo alla
sottorete $R_0$ un unico arco con costo uguale alla latenza effettiva
di $l_0$, formalmente stiamo definendo $R'=(V',A',P',s,t,X,l')$ con:
\begin{itemize}
\item $V' = \pa{V\setminus V_0}\cup \set{s_0,t_0}$,
\item $A' = \pa{A\setminus A_0}\cup \set{\pa{s_0,t_0}}$,
\item $P'$ i percorsi di $P$ con $\pa{s_0,t_0}$ al posto dei
  percorsi in $P_0$,
\item Per $j\in A\setminus A_0$ definiamo $l'_j = l_j$
\item $l'_{\pa{s_0,t_0}} = l_0$.
\end{itemize}

\begin{mydef}[Instradamento parzialmente ottimo]
  Data un'istanza $R$ e una sua sottrete $R_0$ una soluzione $x$ di
  $R$ è un \textbf{instradamento parzialmente ottimo} se su
  $A\setminus A_0$ coincide con $x^{WE}(R')$, indichiamo tale
  soluzione con
  \[ x^{POR}(R,R_0) \]
\end{mydef}

Non abbiamo definito la soluzione sugl'archi di $R_0$, per farlo ci
basta calcolare una soluzione socialmente ottima per $R_0\pa{x_0}$
dove $x_0$ è il flusso sull'arco $\pa{s_0,t_0}$ in $R'$.

Come al solito, la scrittura $x^{POR}\pa{R,R_0}$ non è ben definita
perché la soluzione al problema potrebbe non essere unica. È comunque
ben definita la quantità $C\pa{x^{POR}\pa{R,R_0}}$.

All'inizio della sezione abbiamo supposto di avere un unico operatore.
La definizione si può facilmente estendere al caso in cui sono
presenti più operatori (ognuno dei quali gestisce una sua sottorete
che non si intereseca con le altre) semplicemente sostituendo ad ogni
sottorete la sua latenza effettiva.

Continuiamo a mantenere, per semplicità, l'ipotesi di avere un unico
operatore, ma tutti i risultati che mostriamo ora si possono estendere
al caso di più operatori.

\subsection{Inefficienza dell'instradamento parzialmente ottimo}
\label{sec:inefficienza-por}

\subsubsection{Paradosso POR}
\label{sec:paradosso-por}

Calcolando la soluzione parzialmente ottima potremmo aspettarci che
avendo migliorato l'instradamento in una porzione della rete il costo
globale non possa aumentare. Invece questo può accadere, come in
effetti accade nel prossimo esempio.

\begin{myes}
  Consideriamo l'istanza $R$ di figura \ref{fig:paradosso-por} e
  scegliamo come sottorete gli archi colorati in blu (quindi i nodi 1
  e 2 e gli archi che li congiungono).

  \begin{figure}[ht]
    \centering
    \begin{tikzpicture}[mnode/.style={circle,fill=blue!20,minimum size=0.65cm},>=latex,snode/.style={circle,fill=red!70}]
      \node[mnode] (0) at (0,0) {0}; 
      \node[mnode] (1) at (4,2) {1};
      \node[mnode] (2) at (4,-2) {2};
      \node[mnode] (3) at (8,0) {3};
      \draw [->] (0) to node[above] {$x$} (1);
      \draw [->] (0) to node[below] {$1.25$} (2);
      \draw [->] (1) to node[above] {$3.25$} (3);
      \draw [->] (2) to node[below] {$3x$} (3);
      \draw [->,blue] (1) to [bend right] node[left] {$l_5(x) = 0.31$} (2);
      \draw [->,blue] (1) to [bend left] node[right] {$l_6(x) = 0.4x$} (2);
      \draw [->,color=red] (-1,0) -- node[above,color=black] {$1$} (0) ;
      \draw [->,color=red] (3) -- (9,0) ;
      \draw [dashed,->] (1) to node {$l_0(X_0)$}(2) ;
    \end{tikzpicture}
    \caption{Esempio in cui accade un paradosso POR}
    \label{fig:paradosso-por}
  \end{figure}

  Come prima cosa calcoliamo un equilibrio di Wardrop per l'intera
  rete (ignorando, quindi, la presenza del provider), la soluzione che
  si ottiene ha costo globale
  \[ C\pa{x^{WE}\pa{R}} = 4.19 \]
  
  Calcoliamo ora una soluzione parzialmente ottima di $R$, per farlo
  dobbiamo prima calcolare la latenza effettiva di $R_0$
  \[ l_0\pa{X_0} = \left\{
      \begin{matrix}
        0.4 X_0 & \text{ se } 0 \le X_0 < 0.3875 \\
        0.31 - \frac{0.0961}{1.6X_0} & \text{ se } X_0 \ge 0.3874
      \end{matrix} \right.
  \]
  a questo punto possiamo calcolare la soluzione POR ottenendo un
  costo globale $C\pa{x^{POR}\pa{R,R_0}} = 4.25$ che è strattamente
  maggiore del costo della soluzione POR.

  Osserviamo che se avessimo calcolato anche una latenza effettiva
  ``di Wardrop'' (cioè calcolando un equilibrio di Wardrop all'interno
  di $R_0$) la soluzione globale ottenuta utilizzando questa latenza
  effettiva coinciderebbe con $x^{WE}\pa{R}$. Questa funzione è:
  \[ \tilde l _0 \pa{X_0} = \min\set{0.31, 0.4X_0} \]
  che è sempre minore o uguale di $l_0\pa{X_0}$.

  Quindi possiamo dire che esiste un paradosso di Braess in $R'$
  centrato nell'arco $\pa{s_0,t_0}$.
\end{myes}

Il precedente esempio, oltre a mostrarci un caso in cui la soluzione
POR è socialmente peggiore della soluzione di Wardrop, ci suggerisce
un possibile collegamento tra questo tipo di comportamento e il
fenomeno del paradosso di Braess.

\begin{mydef}[POR paradox]
  Data un'istanza $R$ e una sua sottorete $R_0 \subseteq R$ diciamo
  che abbiamo un \textbf{partially optimal routing paradox} in $R$
  centrato in $R_0$ se 
  \[ C\pa{ x^{POR} (R,R_0)} > C\pa{ x^{WE} (R)} \]
\end{mydef}

\begin{myteo}[Paradosso POR come paradosso di Braess]
  Se una rete $R$ ha un \textbf{paradosso POR} centrato in
  $R_0\subseteq R$ allora esiste un \textbf{paradosso di Braess} in
  $R$ centrato in $R_0$.
\end{myteo}

Non dimostriamo questo teorema (la dimostrazione si può trovare in
\cite[Proposizione 1]{acemoglu2007}) ma mostriamo un importante
corollario:
\begin{mycor}
  Data un'istanza $R$, se non ci sono paradossi di Braess in $R$
  allora la soluzione POR rispetto a qualsiasi sottorete
  $R_0 \subseteq R$ \textbf{non peggiora} il costo globale.
\end{mycor}

Questo corollario ci dà un criterio per capire quando possiamo
introdurre l'instradamento parzialmente ottimo senza rischiare di
peggiorare la qualità del servizio globale.

\subsubsection{Prezzo dell'anarchia per POR}
\label{sec:poa-por}

Analogamente a quanto abbiamo fatto per l'equilibrio di Wardrop,
vogliamo analizzare per opportuni $\mathcal{R}' \subseteq \mathcal{R}$
la quantità
\[ \inf _{R \in \mathcal{R}', R_0 \subseteq R}
  \frac{C\pa{x^{SO}\pa{R}}}{C\pa{x^{POR}\pa{R,R_0}}} \]

Un primo risultato di confronto con l'instradamento di Wardrop è dato
dalla prossima proposizione.
\begin{mypro}
Vale:
  \begin{enumerate}
    % \item $\forall \mathcal{R}' \in \set{\mathcal{R}^{conv},
    %   \mathcal{R}^{aff}, \mathcal{R}^{conc}}$ si ha
  \item $\forall \mathcal{R}' \subseteq \mathcal{R}$
    \[ \inf _{\small\begin{matrix}R\in \mathcal{R}'\\R_0\subseteq
          R\end{matrix}}
      \frac{C\pa{x^{SO}(R)}}{C\pa{x^{POR}(R,R_0)}} \le
      \inf _{R\in \mathcal{R}'}
      \frac{C\pa{x^{SO}(R)}}{C\pa{x^{WE}(R)}}
    \]
  \item
    \[ \inf _{\small\begin{matrix}R\in \mathcal{R}\\R_0\subseteq
          R\end{matrix}}
      \frac{C\pa{x^{SO}(R)}}{C\pa{x^{POR}(R,R_0)}} =
      \inf _{R\in \mathcal{R}}
      \frac{C\pa{x^{SO}(R)}}{C\pa{x^{WE}(R)}}
    \]
  \item
    \[ \inf _{\small\begin{matrix}R\in \mathcal{R}^{aff}\\R_0\subseteq
          R\end{matrix}}
      \frac{C\pa{x^{SO}(R)}}{C\pa{x^{POR}(R,R_0)}} \ge
      \inf _{R\in \mathcal{R}^{conc}}
      \frac{C\pa{x^{SO}(R)}}{C\pa{x^{WE}(R)}}
    \]
  \end{enumerate}
\end{mypro}
\begin{proof}
  \begin{enumerate}
  \item Comunque scegliamo un'istanza $R\in \mathcal{R'}$ possiamo
    costruire una sottorete ``banale'' di $R$ scegliendo un unico
    arco, la soluzione parzialmente ottima ottenuta con questa scelta
    avrà costo globale uguale a quello della soluzione di Wardrop,
    quindi prendendo l'estremo inferiore su $R_0\subseteq R$:
    \[ \inf _{R_0\subseteq R}
      \frac{C\pa{x^{SO}(R)}}{C\pa{x^{POR}(R,R_0)}} \le
      \frac{C\pa{x^{SO}(R)}}{C\pa{x^{WE}(R)}} \]
    prendendo l'estremo inferiore su anche $R\in \mathcal{R}'$ si ha
    la tesi.
  \item Il punto precedente applicato a $\mathcal{R'} =\mathcal{R}$ ci
    dà una disuguaglianza, per dimostrare l'altro verso costruiamo per
    ogni $R\in \mathcal{R}$ e $R_0\subseteq R$ l'istanza $R'$ che
    abbiamo utilizzato per calcolare la soluzione POR, allora per
    definizione si ha
    \[ C\pa{x^{WE}\pa{R'}} = C\pa{x^{POR}\pa{R,R_0}} \]
    e si può dimostrare che
    \[ C\pa{x^{SO}\pa{R'}} = C\pa{x^{SO}\pa{R}} \]
    da cui la disuguaglianza cercata passando all'estremo inferiore.
  \item In modo analogo al punto precedente, data un'istanza $R\in
    \mathcal{R}^{aff}$ e una sua sottrete $R_0\subseteq R$ costruiamo
    l'istanza $R'$; osserviamo che le funzioni costo di $R'$ sono
    tutte affini tranne che per la funzione $l_0$ che abbiamo
    dimostrato nel lemma \ref{lem:l0-concava} essere concava, quindi
    $R'\in \mathcal{R}^{conc}$. Ora possiamo concludere come nel punto
    precedente.
  \end{enumerate}
\end{proof}

Enunciamo e dimostriamo un teorema analogo al teorema di Roughgardend
e Tardos.
\begin{myteo}
\label{teo:poa-por}
  \[ \inf _{\small\begin{matrix}R\in \mathcal{R}^{conv}\\R_0\subseteq
        R\end{matrix}}
    \frac{C\pa{x^{SO}(R)}}{C\pa{x^{POR}(R,R_0)}} = 0\]    
  \[ \inf _{\small\begin{matrix}R\in \mathcal{R}^{aff}\\R_0\subseteq
        R\end{matrix}}
    \frac{C\pa{x^{SO}(R)}}{C\pa{x^{POR}(R,R_0)}} = \frac{3}{4} \]    
\end{myteo}
\begin{proof}
  Dal teorema di Roughgarden and Tardos (teorema
  \ref{teo:roughgarden-tardos}) sappiamo che 
  \[ \inf _{R\in \mathcal{R}^{conv}} \frac{C\pa{ x^{SO}(R)}}{C\pa{
        x^{WE}(R)}} = 0 \]
  mentre dal primo punto della propozione precendente abbiamo
  \[ \inf _{\small\begin{matrix}R\in \mathcal{R}^{conv}\\R_0\subseteq
        R\end{matrix}}
    \frac{C\pa{x^{SO}(R)}}{C\pa{x^{POR}(R,R_0)}} \le
    \inf _{R\in \mathcal{R}^{conv}}
    \frac{C\pa{x^{SO}(R)}}{C\pa{x^{WE}(R)}}
  \]
  da cui la prima parte dell'enunciato
  \[ \inf _{\small\begin{matrix}R\in \mathcal{R}^{conv}\\R_0\subseteq
        R\end{matrix}}
    \frac{C\pa{x^{SO}(R)}}{C\pa{x^{POR}(R,R_0)}} = 0\]    
  
  Per la seconda parte richiamiamo il teorema sull'efficienza
  dell'equilibrio di Wardrop per funzioni concave (teorema
  \ref{teo:poa-we-conc}) che ci dice che:
  \[ \inf _{R\in \mathcal{R}^{conc}} \frac{C\pa{ x^{SO}(R)}}{C\pa{
        x^{WE}(R)}} = \frac{3}{4} \]
  mentre il terzo punto della proposizione precedente ci dice che
  \[ \inf _{\small\begin{matrix}R\in \mathcal{R}^{aff}\\R_0\subseteq
        R\end{matrix}}
    \frac{C\pa{x^{SO}(R)}}{C\pa{x^{POR}(R,R_0)}} \ge
    \inf _{R\in \mathcal{R}^{conc}}
    \frac{C\pa{x^{SO}(R)}}{C\pa{x^{WE}(R)}}
  \]
  quindi
  \[ \inf _{\small\begin{matrix}R\in \mathcal{R}^{aff}\\R_0\subseteq
        R\end{matrix}}
    \frac{C\pa{x^{SO}(R)}}{C\pa{x^{POR}(R,R_0)}} \ge \frac{3}{4} \]    
  applicando il primo punto della proposizone con $\mathcal{R}' =
  \mathcal{R}^{aff}$ e utilizzando il teorema di Roughgarden and
  Tardos per funzioni affini abbiamo la tesi.
\end{proof}

\section{Instradamento in presenza di costi fissati dai gestori della rete}

\subsection{Modello e comportamento degli utenti}
\label{sec:prezzi-modello}

In questa sezione chiameremo il costo dato dalle funzioni $l_j$
\textit{latenza} in modo da non confonderlo con il costo economico
(\textit{prezzo}) che stiamo per introdurre.

Per aggiungere al nostro modello un \textbf{costo economico} (che gli
utenti devono pagare per utilizzare la rete) aggiungiamo ad ogni arco
$j\in A$ un prezzo unitario $p_j$, l'utente pagherà sia in latenza sia
in costo economico, in particolare per attraversare l'arco $j$
pagherà:
\[ l_j\pa{x_j} + p_j \]
per semplicità stiamo mescolando le due misure diverse ($l_j$ potrebbe
rappresentare un tempo mentre $p_j$ una valuta).

A differenza delle latenze (che sono intrinseche della rete stradale),
i prezzi verranno decisi dai gestori dei singoli archi, ogni gestore
cercherà di massimizzare il proprio profitto.

Per semplificare il modello (e riuscire ad ottenere dei risultati
significativi) supponiamo che la nostra rete sia costituita da una
sorgente, una destinazione e $I$ archi $\mathcal{I} = \set{1,...,I}$
in parallelo ognuno con una funzione latenza $l_i$ \textbf{convessa},
\textbf{non decrescente}, \textbf{differenziabile} e \textbf{nulla in
  $0$}. Un esempio di tale rete è disegnato in figura \ref{fig:provider}

\begin{figure}[ht]
  \centering
  \begin{tikzpicture}[mnode/.style={circle,fill=blue!20},>=latex,snode/.style={circle,fill=red!70}]
    \node[mnode] (s) at (0,0) {s};
    \node[mnode] (t) at (5,0) {t};
    \draw [->,color=blue] (s) to [bend left=40] node[above] {\small $l_1(x_1)$, $p_1$} (t);
    \draw [->,color=green] (s) to [bend left=20] node[above] {\small $l_2(x_2)$, $p_2$} (t);
    \draw [->,color=black] (s) to node[above] {\small $l_3(x_3)$, $p_3$} (t);
    \draw [->,color=black] (s) to [bend right=20] node[above] {\small $l_4(x_4)$, $p_4$} (t);
    \draw [->,color=magenta] (s) to [bend right=40] node[above] {\small $l_5(x_5)$, $p_5$} (t);
  \end{tikzpicture}
  \caption{Esempio di rete nel nuovo modello: i diversi colori
    degl'archi indicano i diversi gestori}
  \label{fig:provider}
\end{figure}

Come già detto, i provider sceglieranno i prezzi in modo da
massimizzare il loro profitto, gli utenti continueranno a scegliere
quale strada utilizzare per minimizzare la latenza ed il costo della
trasmissione.

Prevediamo anche un limite superiore (\textit{reservation utility})
alla spesa (sia in termini di latenza che in termini di spesa) che
l'utente è disposto a sostenere.

\begin{mydef}
  Dato l'insieme di archi $\mathcal{I}$, le loro funzioni
  latenza $\bra{l_i}_i\in\mathcal{I}$ e il vettore dei prezzi
  $\bra{p_i}_{i\in\mathcal{I}}$ scelti dai provider diciamo che un
  vettore $x\in \mathbb{R}_+^\mathcal{I}$ è \textbf{soluzione del
    problema} se:
  \begin{align*}
    \forall i\in \mathcal{I}\;\; & x_i \ge 0 \\
    \forall i\in \mathcal{I}\;\; & l_i(x_i) + p_i \le R \\
    & \sum _{i\in \mathcal{I}} x_i \le d 
  \end{align*}
  Dove $R$ è la \textit{reservation utility} (il massimo costo totale
  che gli utenti sono disposti a pagare) e $d$ è la quantità (massima)
  di traffico che si vuole instradare.
\end{mydef}

Possiamo riapplicare la definizione di equilibrio di Wardrop a questo
nuovo caso usando le nuove funzioni costo $l_i\pa{x_i} + p_i$ ottenendo

\begin{mydef}
  Una soluzione $x\in \mathbb{R}_+^\mathcal{I}$ è un
  \textbf{equilibrio di Wardrop} se:
  \begin{align*}
    l_i(x_i) + p_i &= \min _j \set{l_j(x_j)+p_j} & \forall i\text{ con } x_i>0 \\
    l_i(x_i) + p_i &\le R \\
    \sum _{i\in \mathcal{I}} x_i &\le d \\
    \sum _{i\in \mathcal{I}} x_i &= d & \text { se } \min _j
                                        \set{l_j(x_j)+p_j} <R
  \end{align*}
  indichiamo una tale soluzione con $x^{WE}$.
\end{mydef}

Nella definzione di equilibrio di Wardrop abbiamo inserito l'ultima
condizione in modo da garantire che venga instradata la massima
quantità di traffico possibile senza sforare la \textit{reservation
  utility}\footnote{Dovremmo in realtà prevedere anche il caso in cui
  abbiamo raggiunto la reservation utility ma possiamo ancora
  aumentare il traffico (succede se almeno una funzione latenza è
  costante in un intorno destro del valore dell'equilibrio), ma non lo
  facciamo per non appesantire la trattazione}.

Siccome non abbiamo chiesto la stretta crescenza delle funzioni
latenza, l'equilibrio di Wardrop può non essere unico, chiamiamo
quindi $W(p)$ l'insieme degli equilibri di Wardrop con vettore
dei prezzi $p$.

La definizione di costo globale (definizione \ref{def:costo-globale})
non tiene in considerazione la \textit{reservation utility}, quindi se
cercassimo semplicemente di minimizzare il costo globale otterremmo
che la soluzione ottima ha traffico nullo su tutti gli archi. Per
questo introduciamo una nuova funzione obiettivo.

\begin{mydef}[Social surplus]
  Data una soluzione $x$ chiamiamo \textit{social surplus} la
  quantità:
  \[ \mathbb{S}(x) = \sum _{i\in\mathcal{I}}\pa{ R -
      l_i\pa{x_i}}x_i \]
\end{mydef}

Questa funzione rappresenta la differenza tra quanto gli utenti sono
disposti a spendere e quanto spendono in \textbf{latenza}, il prezzo
degli archi quindi non compare.

Osserviamo che per $R$ sufficientemente grande (quando tutto il
traffico viene instradato) si ha:
\[ \mathbb{S}(x) = Rd - C(x) \]
quindi la nuova funzione di \textit{social surplus} non è troppo
lontana dalla vecchia funzione costo globale.

Diamo ora una definizione aggiornata di soluzione socialmente ottima
\begin{mydef}[Soluzione socialmente ottima]
  Diciamo che una soluzione è un \textbf{ottimo sociale} se risolve il
  problema:
  \begin{align*}
    \text{massimizzare }\;\; & \mathbb{S}(x) = \sum
                               _{i\in\mathcal{I}}\pa{ R - l_i\pa{x_i}}x_i
    \\
    \text{tale che }\;\; & x\ge 0\\
                             & l_i(x) \le R \\
                             & \sum _{i\in \mathcal{I}} x_i \le d
  \end{align*}
  indichiamo\footnote{Non usiamo $x^{SO}$ per non confonderci con la
    soluzione della definizione \ref{def:soluzione-so}}. una tale
  soluzione con $x^S$.
\end{mydef}

La soluzione socialmente ottima non sarà unica, ma diverse soluzioni
avranno lo stesso social surplus, quindi è ben definita la quantità
\[ \mathbb{S}\pa{x^{S}} \]

Osserviamo che l'ottimo sociale non dipende dai prezzi, infatti oltre
a non essere presenti nella funzione obiettivo, non sono presenti
nemmeno nei vincoli.

Anche l'equilibrio di Wardrop può non essere unico e, a differenza dei
casi precedenti, due equilibri di Wardrop possono avere social surplus
diversi, scriviamo quindi
\[ \mathbb{S}\pa{x^{WE}} = \max _{x\in W(p)} \mathbb{S}\pa{x} \]

Si può dimostare che questo massimo si raggiunge quando si massimizza
la quantità di traffico effettivamente instradata $\sum _{i\in
  \mathcal{I}} x_i$.

\subsection{Comportamento dei gestori}
\label{sec:prezzi-gestori}

Nella sezione precedente abbiamo definito come si comportano gli
utenti in funzione dei prezzi della rete, ma non abbiamo detto come
vengono scelti i prezzi dai gestori.

Iniziamo dal caso più semplice in cui tutti gli archi $\mathcal{I}$
sono gestiti da un monopolista che, una volta decisi i prezzi $p_i$, e
data una soluzione $x\in W(p)$, otterrà il guadagno:
\[ \Pi (p,x) = \sum _{i\in\mathcal{I}} p_i x_i \]

La scelta che massimizza il suo guadagno sarà data dall'equilibrio di
monopolio.
\begin{mydef}[Equilibrio di monopolio]
  I vettori $\pa{p^{ME},x^{ME}}\ge 0$ sono un \textbf{equilibrio di
    monopolio} se $x^{ME}\in W(p^{ME})$ e 
  \begin{align*}
    \forall p\ge 0,\; \forall x\in W(p) && \Pi \pa{p^{ME},x^{ME}}
                                           \ge \Pi \pa{p,x}
  \end{align*}
\end{mydef}

Osserviamo che quando ``proviamo'' un nuovo prezzo $p\ge 0$ per
calcolare il guadagno $\Pi$ dobbiamo prima calcolare una nuova
soluzione $x\in W\pa{p}$, cioè stiamo calcolando la risposta degli
utenti al nuovo prezzo del gestore.

Analogamente a quanto fatto con le altre nozioni di equilibrio,
possiamo calcolare una quantità simile al prezzo dell'anarchia, questa
quantità sarà ora:
\[ \inf \frac{\mathbb{S}\pa{x^{ME}}}{\mathbb{S}\pa{x^S}} \]

In realtà si scopre che questo rapporto è sempre $1$, infatti vale
il seguente teorema:

\begin{myteo}[Ottimalità dell'equilibrio di
  monopolio{\cite[Proposizione 3.2]{acemoglu2007-2}}]
  Un vettore $x\in \mathbb{R}_+^\mathcal{I}$ è un \textbf{equilibrio
    di monopolio} se e solo se è un \textbf{ottimo sociale}.
\end{myteo}

Non dimostriamo questo teorema (la dimostrazione si può trovare
nell'articolo citato), ma osserviamo che il risultato non è così
sorprendente se consideriamo che:
\begin{enumerate}
\item l'operatore può ``spostare'' il traffico da un arco all'altro
  semplicemente ritoccando i prezzi, quindi (ser pur indirettamente)
  può decidere la distribuzione del traffico;
\item il massimo prezzo che può fissare su un arco (dato il traffico)
  è $R - l_i(x_i)$, quindi massimizzare questa quantità massimizza il
  guadagno dell'operatore;
\item il social surplus è definito proprio come
  $\sum _{i\in\mathcal{I}}\pa{ R - l_i\pa{x_i}}x_i$
\end{enumerate}


Passiamo ora al caso in cui sono presenti $S$ operatori e ognuno di
questi controlla il prezzo di un certo sottoinsieme di link
$\mathcal{I}_s$ (per $s\in S$).

Il guadagno di ogni operatore dipende dalla disposizione del traffico
e quindi sia dalla sua scelta dei prezzi sia della scelta degli
altri. Si crea quindi un gioco tra gli operatori.

Dato un operatore $s\in S$ definiamo:
\begin{itemize}
\item $p_s = \bra{p_i}_{i\in \mathcal{I}_s}$
\item $p_{-s} = \bra{p_i}_{i\not\in \mathcal{I}_s}$
\item $\displaystyle \Pi _s \pa{p_s, p_{-s},x} = \sum _{i\in
    \mathcal{I}_s} p_i x_i\;$ con $x\in W\pa{p_s, p_{-s}}$
\end{itemize}

Il gioco risultante avrà:
\begin{itemize}
\item insieme dei giocatori $S$,
\item insieme delle strategie del giocatore $s$: $\mathbb{R}_+
  ^{\abs{\mathcal{I}_s}}$,
\item funzioni guadagno $\Pi _s$
\end{itemize}

Ogni provider cercherà di massimizzare il proprio profitto, siamo
quindi in una situazione in cui vogliamo cercare un \textbf{equilibrio
  di Nash}.

L'equilibrio di Nash per questo gioco si traduce nell'equilibrio di
oligopolio così definito:
\begin{mydef}[Equilibrio di oligopolio]
  Diciamo che i vettori $\pa{p^{OE},x^{OE}}\ge 0$ sono un
  \textbf{equilibrio di oligopolio} se $x^{OE}\in W\pa{p^{OE}}$ e
  $\forall s\in S$ si ha:
  \begin{align*}
    & \forall p_s \ge 0\;\;\; \forall x\in W\pa{p_s,p^{OE}_{-s}} \\
    & \Pi_s \pa{p^{OE}_s, p^{OE}_{-s},x^{OE}} \ge \Pi _s \pa{p_s, p^{OE}_{-s},x}
  \end{align*}
\end{mydef}

Ancora una volta vogliamo dare un limite al prezzo dell'anarchia, si
può quindi dimostrare il seguente teorema:

\begin{myteo}[Efficienza dell'equilibrio di
  oligopolio{\cite[Teorema 5.2]{acemoglu2007-2}}]
  Data una rete composta da $I$ link paralleli gestiti da $S$
  provider, dette $x^{S}$ una soluzione socialmente ottima e
  $\pa{p^{OE},x^{OE}}$ un equilibrio di oligopolio, si ha:
  \[ \frac{\mathbb{S}\pa{x^{OE}}} {\mathbb{S}\pa{x^S}} \ge
    \frac{5}{6} \]
\end{myteo}
Non dimostriamo questo teorema (la dimostrazione si può trovare
nel'articolo citato), ma mostriamo un esempio in cui si ottiene il
minimo di questa quantità.

\begin{myes}
  Consideriamo una rete dove ogni arco è di proprietà di un gestore
  diverso, sia $d=1$ il flusso massimo che vogliamo instradare e $R=1$
  la \textit{reservation utility}, supponiamo che le latenze siano:
  \begin{align*}
    l_1(x_1) &= 0 \\
    l_i(x_i) &= \frac{3}{2}(I-1)x_i & 2 \le i \le I
  \end{align*}
  Il flusso ottimo sarà
  \[ x^S = \bra{1,0,0,\dots, 0} \]
  mentre si può vedere che l'equilibrio di oligopolio avrà flusso
  \[ x^{OE} = \bra{ \frac{2}{3}, \frac{1}{3(I-1)}, \dots ,
      \frac{1}{3(I-1)}} \]
  si ottiene
  \begin{align*}
    \mathbb{S}\pa{x^S} & = 1 & \mathbb{S}\pa{x^{OE}} & = \frac{5}{6}
  \end{align*}
\end{myes}


\appendix

\section{Teoria dei giochi}
\label{sec:teoria-giochi}

In questa appendice diamo alcune definizioni di teoria dei giochi che
abbiamo usato precedentemente.

\begin{mydef}[Gioco]% strategico]
  Un gioco è dato da $\pa{\mathcal{I},\pa{S_i}_{i\in\mathcal{I}},
    \pa{u_i}_{i\in\mathcal{I}}}$ con:
  \begin{itemize}
  \item $\mathcal{I}$ insieme \textbf{finito} dei giocatori,
  \item $S_i$ insieme non vuoto delle azioni possibili per il
    giocatore $i$,
  \item $u_i: \prod _{i\in\mathcal{I}} S_i \to \mathbb{R}$ guadagno
    per il giocatore $i$ in funzione delle azioni di tutti i
    giocatori.
  \end{itemize}
\end{mydef}

L'obiettivo di ogni giocatore è di massimizzare il proprio guadagno,
in generale il suo guadagno dipenderà sia dalla strategia da lui
scelta, sia dalla strategia scelta dagl'altri giocatori.

\begin{myes}[Matching pennies]
\label{es:matching-pennies}
  In questo gioco due giocatori mostrano contemporaneamente la faccia
  di una moneta (dopo averla scelta segretamente), se le facce sono
  uguali vince il primo giocatore, se sono diverse il secondo.
  
  Formalizzando abbiamo:
  \begin{align*}
    \mathcal{I} &= \set{1,2} &
                               S_1 = S_2 &= \set{\text{Testa},\text{Croce}}
  \end{align*}
  \begin{table}[!ht]
    \centering
    \begin{tabular}{rcc}
      & Testa & Croce \\
      \cline{2-3}
      Testa & \multicolumn{1}{|c|}{$1,-1$} & \multicolumn{1}{|c|}{$-1,1$}  \\
      \cline{2-3}
      Croce & \multicolumn{1}{|c|}{$-1,1$} & \multicolumn{1}{|c|}{$1,-1$}  \\
      \cline{2-3}
    \end{tabular}
    
    \caption{Funzioni guadagno per \textit{matching pennies}, le righe
      rappresentano la scelta del primo giocatore, le colonne la scelta
      del secondo giocatore, in ogni cella si può leggere il valore di
      $u_1,u_2$}
    \label{tab:u1u2-matching-pennies}
  \end{table}
  Questo metodo tabellare di rappresentare i giochi a due giocatori è
  molto comodo, infatti lo abbiamo usato anche nell'esempio
  \ref{es:pigou-nash}.
\end{myes}

Dobbiamo analizzare il guadagno di ogni giocatore in funzione di tutte
le scelte, per ogni giocatore $i$ separiamo l'azione del giocatore
stesso dall'azione degl'altri giocatori, quindi definiamo:
\begin{itemize}
\item $S = \prod _{i\in\mathcal{I}} S_i$,
\item se $s = \bra{s_i}_{i\in\mathcal{I}} \in S$ allora $s_{-i} =
  \bra{s_j}_{j\neq i}$
\item $\displaystyle S_{-i} = \prod _{j\in\mathcal{I},j\neq i} S_j$,
\end{itemize}

Ci chiediamo quale sia la strategia migliore per un giocatore, se
esiste una strategia $s_i\in S_i$ che massimizza il guadagno qualunque
sia la scelta degl'altri giocatori ci aspettiamo che il giocatore la
giochi, definiamo quindi cos'è una strategia dominante

\begin{mydef}[Strategia dominante]
  Per un giocatore $i\in\mathcal{I}$ un'azione $s_i\in S_i$ è una
  \textbf{strategia dominante} se:
  \[ \forall s_{-i} \in S_{-i}\;\; \forall s_i' \in S_i\;\;\;
    u_i\pa{s_i,s_{-i}} \ge u_i\pa{s_i',s_{-i}} \]
\end{mydef}

\begin{myes}[Dilemma del prigioniero]
  Due criminali vengono arrestati per aver commesso un reato, hanno a
  disposizione due scelte: collaborare o non collaborare con la
  polizia, in base alle loro scelte verrà deciso quanti anni di
  carcere dovranno fare. Le loro funzioni guadagno sono descritte in
  tabella \ref{tab:u1u2-prigioniero}.
  
  \begin{table}[!ht]
    \centering
    \begin{tabular}{rcc}
      & Non collaborare & Collaborare \\
      \cline{2-3}
      Non collaborare & \multicolumn{1}{|c|}{$-2,-2$} & \multicolumn{1}{|c|}{$-5,-1$}  \\
      \cline{2-3}
      Collaborare & \multicolumn{1}{|c|}{$-1,-5$} & \multicolumn{1}{|c|}{$-4,-4$}  \\
      \cline{2-3}
    \end{tabular}
    \caption{Funzioni guadagno per il dilemma del prigioniero}
    \label{tab:u1u2-prigioniero}
  \end{table}
  
  Si può vedere che la strategia ``collaborare'' è una
  \textbf{strategia dominante}.

  Osserviamo anche che la strategia (collaborare--collaborare) (che
  massimizza il profitto di ognuno) in realtà non rappresenta il
  massimo guadagno possibile, infatti la strategia (non collaborare --
  non collaborare) dà un guadagno strettamente maggiore ad entrambi i
  prigionieri. Possiamo quindi dire che l'egoismo sta facendo fare più
  anni di carcere ad entrambi.
\end{myes}

Non in tutti i giochi esiste una strategia dominante per ogni
giocatore, in alcuni giochi potrebbe esistere solo per alcuni
giocatori, in altri potrebbe non esistere per alcun giocatore.

Vediamo un esempio in cui non è disponibile una strategia dominate

\begin{myes}[Dilemma del prigioniero con suicidio]
  Ora i prigionieri hanno a disposizione una terza strategia:
  suicidarsi. Le funzioni guadagno sono descritte in tabella
  \ref{tab:u1u2-prigioniero-suicidio}.
  \begin{table}[!ht]
    \centering
    \begin{tabular}{rccc}
      & Non collaborare & Collaborare & Suicidarsi \\
      \cline{2-4}
      Non collaborare & \multicolumn{1}{|c|}{$-2,-2$} & \multicolumn{1}{|c|}{$-5,-1$} & \multicolumn{1}{|c|}{$0,-20$}  \\
      \cline{2-4}
      Collaborare & \multicolumn{1}{|c|}{$-1,-5$} & \multicolumn{1}{|c|}{$-4,-4$}  & \multicolumn{1}{|c|}{$-4,-20$} \\
      \cline{2-4}
      Suicidarsi & \multicolumn{1}{|c|}{$-20,0$} & \multicolumn{1}{|c|}{$-20,-4$}  & \multicolumn{1}{|c|}{$-20,-20$} \\
      \cline{2-4}
    \end{tabular}
    \caption{Funzioni guadagno per il dilemma del prigioniero con
      suicidio}
    \label{tab:u1u2-prigioniero-suicidio}
  \end{table}

  In questo caso non c'è una strategia dominante, infatti
  ``Collaborare'' massimizza il guadagno se l'altro giocatore non
  collabora, mentre ``non collaborare'' massimizza il guadagno se
  l'altro giocatore si suicida\footnote{Utilizzando il concetto di
    \textit{strategia strettamente dominata} potremmo risolvere questo
    gioco scartando le scelte ``suicidio'', ma non ci serve ai fini
    della nostra trattazione}.

  Osserviamo, però, che se ``suggerissimo'' ai giocatori (informando
  ognuno anche delle scelte suggerite agl'altri) di giocare la
  strategia (collaborare--collaborare) allora questi non avrebbero
  interesse a spostarsi, ad esempio il primo giocatore vede che gli
  conviene seguire il suggerimento se suppone che l'altro giocatore lo
  stia seguendo.
\end{myes}

La possibile esistenza di una strategia ``stabile'' che abbiamo visto
nell'esempio precedente porta alla definizione di quilibrio di Nash.

\begin{mydef}[Equilibrio di Nash]
  Sia  $\pa{\mathcal{I},\pa{S_i}_{i\in\mathcal{I}},
    \pa{u_i}_{i\in\mathcal{I}}}$ un gioco, allora  
  $s^* \in S$ è un equilibrio di Nash se
  \[ \forall i\in \mathcal{I}\;\; \forall s_i \in S_i \;\;\;
    u_i\pa{s^*_i,s^*_{-i}} \ge u_i\pa{s_i,s^*_{-i}} \]
\end{mydef}

\begin{myoss}
  Se ogni giocatore ha a disposizione una strategia dominante allora
  il vettore delle strategie dominanti è un equilibrio di Nash.
  
  Il viceversa in generale è falso.
\end{myoss}

L'equilibrio di Nash potrebbe non esistere o esistere ma non essere
unico. Ad esempio si può vedere che in \textit{matching pennies}
(esempio \ref{es:matching-pennies}) non esiste alcun equilibrio di
Nash, nel prossimo esempio invece non abbiamo l'unicità.

\begin{myes}[Battaglia dei sessi]
  In questo gioco i due giocatori possono decidere se andare all'opera
  o se andare a vedere la partita di football, ognuno ha una
  preferenza per una delle due possibilità, ma entrambi preferiscono
  andare ad un evento insieme invece che da soli. Le funzioni guadagno
  sono rappresentate in tabella \ref{tab:u1u2-sessi}.
  
  \begin{table}[!ht]
    \centering
    \begin{tabular}{rcc}
      & Opera & Football \\
      \cline{2-3}
      Opera & \multicolumn{1}{|c|}{$2,1$} & \multicolumn{1}{|c|}{$0,0$}  \\
      \cline{2-3}
      Football & \multicolumn{1}{|c|}{$0,0$} & \multicolumn{1}{|c|}{$1,2$}  \\
      \cline{2-3}
    \end{tabular}
    \caption{Funzioni guadagno per la battaglia dei sessi}
    \label{tab:u1u2-sessi}
  \end{table}
  
  Qui esistono due equilibri di Nash: $\pa{\text{Opera},\text{Opera}}$
  e $\pa{\text{Football},\text{Football}}$.
\end{myes}

\bibliographystyle{ieeetr}

\bibliography{menache2011network,wardrop1952,haurie1985,roughgarden2002,braess1968,acemoglu2007,acemoglu2007-2}

\end{document}